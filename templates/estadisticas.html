{% extends "layout.html" %}
{% block content %}

<style>
    /* 游댳 Controlar tama침o fijo de las gr치ficas */
    .chart-box {
        height: 320px;
        position: relative;
    }
</style>

<div class="container mt-4">

    <h2 class="text-center">Estad칤sticas de {{ usuario }}</h2>

    <!-- RESUMEN DEL MES -->
    <div class="row mt-4 g-3">
        <div class="col-md-4">
            <div class="card p-3 bg-light shadow-sm">
                <h5>Ingreso del Mes</h5>
                <h3 class="text-success">S/ {{ ingreso_mes or 0 }}</h3>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-3 bg-light shadow-sm">
                <h5>Gasto del Mes</h5>
                <h3 class="text-danger">S/ {{ gasto_mes or 0 }}</h3>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-3 bg-light shadow-sm">
                <h5>Ahorro Real</h5>
                <h3 class="text-primary">S/ {{ ahorro_real or 0 }}</h3>
            </div>
        </div>
    </div>

    <!-- RESUMEN HIST칍RICO -->
    <div class="row mt-4 g-3">
        <div class="col-md-6">
            <div class="card shadow-sm p-3">
                <h5 class="text-center">Total hist칩rico de ingresos</h5>
                <h3 class="text-success text-center">S/ {{ total_ingresos or 0 }}</h3>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm p-3">
                <h5 class="text-center">Total hist칩rico de gastos</h5>
                <h3 class="text-danger text-center">S/ {{ total_gastos or 0 }}</h3>
            </div>
        </div>
    </div>

    <!-- META DE AHORRO -->
    <div class="mt-4 card p-3 shadow-sm">
        <h4>Meta del Mes: S/ {{ meta or 0 }}</h4>
        <p>Progreso: <b>{{ progreso_meta or 0 }}%</b></p>

        <div class="progress">
            <div class="progress-bar bg-info"
                 style="width: {{ progreso_meta or 0 }}%">
            </div>
        </div>
    </div>

    <!-- GR츼FICA DE INGRESOS VS GASTOS -->
    <div class="card mt-4 p-3 shadow-sm">
        <h4 class="text-center">Ingresos vs Gastos por Mes ({{ now.year }})</h4>
        <div class="chart-box">
            <canvas id="chartLine"></canvas>
        </div>
    </div>

    <!-- GR츼FICA DE GASTOS POR CATEGOR칈A -->
    <div class="card mt-4 p-3 shadow-sm">
        <h4 class="text-center">Gastos por Categor칤a</h4>
        <div class="chart-box">
            <canvas id="chartPie"></canvas>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // -------------------------------
    // DATOS DEL BACKEND (CORREGIDO)
    // -------------------------------
    const labelsMes  = {{ month_labels | tojson }};
    const ingresos   = {{ ingresos_por_mes | tojson }};
    const gastos     = {{ gastos_por_mes | tojson }};
    const gastosCat  = {{ gastos_categoria | tojson }};

    // Valores seguros (evita errores)
    const safeLabelsMes = (labelsMes && labelsMes.length) ? labelsMes : ["Sin datos"];
    const safeIngresos  = (ingresos && ingresos.length) ? ingresos : [0];
    const safeGastos    = (gastos && gastos.length) ? gastos : [0];

    const catLabels = (gastosCat && gastosCat.length)
        ? gastosCat.map(x => x.categoria)
        : ["Sin datos"];

    const catTotals = (gastosCat && gastosCat.length)
        ? gastosCat.map(x => x.total)
        : [0];

    // -------------------------------
    // GR츼FICO LINEAL
    // -------------------------------
    new Chart(document.getElementById("chartLine"), {
        type: "line",
        data: {
            labels: safeLabelsMes,
            datasets: [
                {
                    label: "Ingresos",
                    data: safeIngresos,
                    borderColor: "#28a745",
                    backgroundColor: "rgba(40,167,69,0.2)",
                    tension: 0.3
                },
                {
                    label: "Gastos",
                    data: safeGastos,
                    borderColor: "#dc3545",
                    backgroundColor: "rgba(220,53,69,0.2)",
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // -------------------------------
    // GR츼FICO PIE
    // -------------------------------
    new Chart(document.getElementById("chartPie"), {
        type: "pie",
        data: {
            labels: catLabels,
            datasets: [{
                data: catTotals,
                backgroundColor: [
                    "#4e73df", "#1cc88a", "#36b9cc", "#f6c23e",
                    "#e74a3b", "#8e44ad", "#2ecc71", "#3498db"
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
</script>

{% endblock %}
